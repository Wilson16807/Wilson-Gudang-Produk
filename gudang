<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaksi Penjualan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4 text-center">ðŸ’°Transaksi Penjualan</h1>

  <!-- Form Input -->
  <div class="card p-3 mb-4"> 
    <div class="row g-2"> 
      <div class="col-md">
        <select id="produkSelect" class="form-select">
          <option value="">Pilih Produk</option>
        </select>
      </div>
      <div class="col-md">
        <input type="number" id="qty" class="form-control" placeholder="Jumlah">
      </div>
      <div class="col-md">
        <input type="number" id="harga" class="form-control" placeholder="Harga" readonly>
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" onclick="tambahDetail()">Tambah</button>
      </div>
    </div>
  </div>

  <!-- Tabel Detail Transaksi -->
  <table class="table table-bordered bg-white">
    <thead>
      <tr>
        <th>Nama</th>
        <th>Harga</th>
        <th>Jumlah</th>
        <th>Subtotal</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="detailList"></tbody>
  </table>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <h4>Total: Rp <span id="totalHarga">0</span></h4>
    <div>
      <span class="me-3 fw-bold">Wilson Djohan</span>
      <button class="btn btn-success" onclick="simpanTransaksi()">Simpan Transaksi</button>
    </div>
  </div>
</div>

<script>
  const SUPABASE_URL = "https://jkvqtdbsuvudqihsydhe.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImprdnF0ZGJzdXZ1ZHFpaHN5ZGhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQ5ODgsImV4cCI6MjA3MzA0MDk4OH0.sg_kyX0bIUH-xno9p-kpi42FRnNBfPIfhFhFv5T-vDc";
  const { createClient } = supabase;
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  let produkList = [];
  let detail = [];

  async function loadProduk() {
    const { data, error } = await db.from("produk").select("*").order("id", { ascending: true });
    if (error) return Swal.fire("Error", error.message, "error");

    produkList = data;
    const select = document.getElementById("produkSelect");
    data.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.nama;
      select.appendChild(opt);
    });
  }

  document.getElementById("produkSelect").addEventListener("change", (e) => {
    const id = e.target.value;
    const produk = produkList.find(p => p.id == id);
    document.getElementById("harga").value = produk ? produk.harga : "";
  });

  function renderDetail() {
    const tbody = document.getElementById("detailList");
    tbody.innerHTML = "";
    let total = 0;

    detail.forEach((item, index) => {
      const tr = document.createElement("tr");
      const subtotal = item.harga * item.qty;
      total += subtotal;
      tr.innerHTML = `
        <td>${item.nama}</td>
        <td>Rp ${item.harga.toLocaleString()}</td>
        <td>${item.qty}</td>
        <td>Rp ${subtotal.toLocaleString()}</td>
        <td><button class="btn btn-danger btn-sm" onclick="hapusDetail(${index})">Hapus</button></td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("totalHarga").textContent = total.toLocaleString();
  }

  function tambahDetail() {
    const id = document.getElementById("produkSelect").value;
    const produk = produkList.find(p => p.id == id);
    const qty = parseInt(document.getElementById("qty").value);

    if (!produk || !qty) {
      return Swal.fire("Oops", "Pilih produk dan isi jumlah", "warning");
    }

    detail.push({ id_produk: produk.id, nama: produk.nama, harga: produk.harga, qty });
    renderDetail();

    document.getElementById("produkSelect").value = "";
    document.getElementById("harga").value = "";
    document.getElementById("qty").value = "";
  }

  function hapusDetail(index) {
    detail.splice(index, 1);
    renderDetail();
  }

  async function simpanTransaksi() {
    if (detail.length === 0) return Swal.fire("Oops", "Tidak ada detail transaksi", "warning");

    const { data, error } = await db.from("transaksi").insert([{ 
      tanggal: new Date().toISOString(),
      total: detail.reduce((a,b)=>a + (b.harga * b.qty), 0),
      detail: detail
    }]);

    if (error) return Swal.fire("Error", error.message, "error");

    Swal.fire("Sukses", "Transaksi berhasil disimpan", "success");
    detail = [];
    renderDetail();
  }

  loadProduk();
</script>

</body>
</html>
